// Prisma Schema â€” Immidit Medical Coordination Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  patient
  nurse
  doctor
  admin
  lab
}

enum ServiceStatus {
  pending_nurse_assignment
  nurse_assigned
  nurse_on_the_way
  vitals_recorded
  awaiting_doctor_review
  awaiting_doctor_approval
  doctor_completed
  completed
  cancelled
}

enum LabOrderStatus {
  pending_patient_confirmation
  pending_sample_collection
  sample_collection_scheduled
  sample_collected
  received_at_lab
  sent_to_lab
  report_ready
  doctor_review_pending
  lab_closed
}

enum TriageLevel {
  mild
  moderate
  severe
}

// ============ MODELS ============

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  phone        String
  role         Role
  gender       String?
  age          Int?
  bloodGroup   String?
  allergicInfo String?
  medicalHistory String?
  createdAt    DateTime @default(now())

  // Relations
  patientRequests ServiceRequest[] @relation("PatientServices")
  nurseRequests   ServiceRequest[] @relation("NurseServices")
  doctorRequests  ServiceRequest[] @relation("DoctorRequests")

  patientLabOrders LabOrder[] @relation("PatientLabOrders")
  doctorLabOrders  LabOrder[] @relation("DoctorLabOrders")

  auditLogs AuditLog[]
  savedAddresses SavedAddress[]
  
  ratingsGiven    Rating[] @relation("RatingsGiven")
  ratingsReceived Rating[] @relation("RatingsReceived")

  prescriptionsAsDoctor  Prescription[] @relation("DoctorPrescriptions")
  prescriptionsAsPatient Prescription[] @relation("PatientPrescriptions")
  followUpTasks          FollowUpTask[] @relation("PatientFollowUps")
}

model ServiceRequest {
  id            String   @id @default(uuid())
  patientId     String
  patient       User     @relation("PatientServices", fields: [patientId], references: [id])
  symptoms      String
  
  // Service Details
  serviceType   String
  serviceCategory String?
  isImmediate    Boolean   @default(false)
  
  // Location
  location      String
  locationDetails Json?    // Snapshot
  addressId     String?
  savedAddress  SavedAddress? @relation(fields: [addressId], references: [id])
  
  // Timing
  scheduledTime    DateTime
  scheduledEndTime DateTime?
  
  // Assignment
  nurseId       String?
  nurse         User?    @relation("NurseServices", fields: [nurseId], references: [id])
  doctorId      String?
  doctor        User?    @relation("DoctorRequests", fields: [doctorId], references: [id])
  
  status        ServiceStatus   @default(pending_nurse_assignment)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinicalReport ClinicalReport?
  doctorAction   DoctorAction?
  labOrders      LabOrder[]
  ratings        Rating[]
  prescriptions  Prescription[]
  followUpTasks  FollowUpTask[]
}

model ClinicalReport {
  id                  String     @id @default(uuid())
  serviceId           String     @unique
  chiefComplaint      String?
  durationOfSymptoms  String?
  vitalsJson          Json
  medicalHistory      String?
  allergies           String?
  currentMedications  String?
  nurseNotes          String
  nurseObservations   String?
  attachments         String[]
  triageLevel         TriageLevel
  createdAt           DateTime   @default(now())

  service      ServiceRequest @relation(fields: [serviceId], references: [id])
  prescription Prescription?
}

model DoctorAction {
  id                  String   @id @default(uuid())
  serviceId           String   @unique
  diagnosis           String
  clinicalNotes       String?
  advice              String?
  medications         String?
  medicinesJson       Json?      // Structured medicines array
  prescriptionUrl     String?
  labRecommended      Boolean  @default(false)
  referralNote        String?
  followupDate        DateTime?
  followupInstruction String?
  
  // Procedure Approval for restricted services
  procedureApproved   Boolean  @default(false)
  approvalNotes       String?
  requestNurseEdit    Boolean  @default(false)
  
  emergencyAction      String?   // hospital_referral, immediate_prescription, continue_care

  service ServiceRequest @relation(fields: [serviceId], references: [id])
}

model Prescription {
  id                   String   @id @default(uuid())
  serviceId            String
  doctorId             String
  patientId            String
  clinicalReportId     String   @unique
  diagnosis            String
  summaryNotes         String?
  vitalsSnapshotJson   Json
  nurseObservations    String?
  medicinesJson        Json
  followUpInstruction  String?
  pdfUrl               String?
  versionNumber        Int      @default(1)
  createdAt            DateTime @default(now())

  service        ServiceRequest  @relation(fields: [serviceId], references: [id])
  doctor         User            @relation("DoctorPrescriptions", fields: [doctorId], references: [id])
  patient        User            @relation("PatientPrescriptions", fields: [patientId], references: [id])
  clinicalReport ClinicalReport  @relation(fields: [clinicalReportId], references: [id])
  versions       PrescriptionVersion[]

  @@index([serviceId])
  @@index([doctorId])
  @@index([patientId])
}

model PrescriptionVersion {
  id                   String   @id @default(uuid())
  prescriptionId       String
  versionNumber        Int
  vitalsSnapshotJson   Json
  nurseObservations    String?
  medicinesJson        Json
  diagnosis            String
  summaryNotes         String?
  createdAt            DateTime @default(now())

  prescription Prescription @relation(fields: [prescriptionId], references: [id])

  @@index([prescriptionId])
}

model FollowUpTask {
  id                  String    @id @default(uuid())
  serviceId           String
  patientId           String
  prescriptionId      String?
  instruction         String
  dueDate             DateTime?
  status              String    @default("pending")  // pending, completed, cancelled
  completedAt         DateTime?
  createdAt           DateTime  @default(now())

  service      ServiceRequest @relation(fields: [serviceId], references: [id])
  patient      User           @relation("PatientFollowUps", fields: [patientId], references: [id])

  @@index([serviceId])
  @@index([patientId])
}

model LabOrder {
  id             String         @id @default(uuid())
  serviceId      String
  patientId      String
  doctorId       String
  testsJson      Json
  urgency        String
  status         LabOrderStatus @default(pending_patient_confirmation)
  collectionTime DateTime?
  createdAt      DateTime       @default(now())

  service  ServiceRequest @relation(fields: [serviceId], references: [id])
  patient  User           @relation("PatientLabOrders", fields: [patientId], references: [id])
  doctor   User           @relation("DoctorLabOrders", fields: [doctorId], references: [id])

  labReport LabReport?
}

model SavedAddress {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  label        String   // Home, Work, Other
  
  // Structured Address
  flatNumber   String?
  buildingName String?
  floor        String?
  landmark     String?
  area         String?
  city         String?
  pincode      String?
  address      String   // Full formatted address string for display
  
  // Coordinates
  lat          Float
  lng          Float
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  ServiceRequests ServiceRequest[]
}

model LabReport {
  id                String    @id @default(uuid())
  labOrderId        String    @unique
  reportUrl         String
  doctorReviewNotes String?
  reviewedAt        DateTime?
  createdAt         DateTime  @default(now())

  labOrder LabOrder @relation(fields: [labOrderId], references: [id])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  actionType String
  entityType String
  entityId   String
  timestamp  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Rating {
  id               String   @id @default(uuid())
  serviceId        String
  service          ServiceRequest @relation(fields: [serviceId], references: [id])
  
  fromUserId       String
  fromUser         User     @relation("RatingsGiven", fields: [fromUserId], references: [id])
  
  toUserId         String
  toUser           User     @relation("RatingsReceived", fields: [toUserId], references: [id])
  
  score            Int      // 1-5 stars
  category         String?  // behavior, guidance, medical_skill etc.
  comment          String?
  
  createdAt        DateTime @default(now())

  @@index([serviceId])
  @@index([toUserId])
}
